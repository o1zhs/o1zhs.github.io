<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> SQL练习3 · Abigale</title><meta name="description" content="SQL练习3 - zhs"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Abigale"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">SQL练习3</h1><div class="post-info">May 14, 2018</div><div class="post-content"><h1 id="SQL实验：触发器"><a href="#SQL实验：触发器" class="headerlink" title="SQL实验：触发器"></a>SQL实验：触发器</h1><h3 id="一、实验目的"><a href="#一、实验目的" class="headerlink" title="一、实验目的"></a>一、实验目的</h3><p>加深和巩固对触发器概念的理解。</p>
<p>掌握触发器的简单应用。</p>
<h3 id="二、实验内容"><a href="#二、实验内容" class="headerlink" title="二、实验内容"></a>二、实验内容</h3><p>学生数据库由三张表组成：xsqk、xskc、xscj，各个表的结构如下：</p>
<h5 id="表1-xsqk结构"><a href="#表1-xsqk结构" class="headerlink" title="表1 xsqk结构"></a>表1 xsqk结构</h5><table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>长度</th>
<th>允许空值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>系别</td>
<td>Char</td>
<td>10</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>班级</td>
<td>Char</td>
<td>12</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>专业</td>
<td>Varchar</td>
<td>30</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>学号</td>
<td>Char</td>
<td>8</td>
<td>×</td>
<td>主键</td>
</tr>
<tr>
<td>姓名</td>
<td>Char</td>
<td>8</td>
<td>×</td>
<td></td>
</tr>
<tr>
<td>性别</td>
<td>Char</td>
<td>2</td>
<td>√</td>
<td>默认值：男</td>
</tr>
<tr>
<td>出生年月</td>
<td>Smalldatetime</td>
<td>4</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>总学分</td>
<td>Tinyint</td>
<td>1</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>备注</td>
<td>Text</td>
<td>16</td>
<td>√</td>
</tr>
</tbody>
</table>
<h5 id="表2-xskc结构"><a href="#表2-xskc结构" class="headerlink" title="表2 xskc结构"></a>表2 xskc结构</h5><table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>长度</th>
<th>允许空值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>课程号</td>
<td>Char</td>
<td>3</td>
<td>×</td>
<td>主键</td>
</tr>
<tr>
<td>课程名</td>
<td>Char</td>
<td>16</td>
<td>×</td>
<td></td>
</tr>
<tr>
<td>开课学期</td>
<td>Tinyint</td>
<td>1</td>
<td>×</td>
<td>规则：1~8</td>
</tr>
<tr>
<td>学时</td>
<td>Tinyint</td>
<td>1</td>
<td>×</td>
<td></td>
</tr>
<tr>
<td>学分</td>
<td>Tinyint</td>
<td>1</td>
<td>√</td>
</tr>
</tbody>
</table>
<h5 id="表3-xscj结构"><a href="#表3-xscj结构" class="headerlink" title="表3 xscj结构"></a>表3 xscj结构</h5><table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>长度</th>
<th>允许空值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>学号</td>
<td>Char</td>
<td>8</td>
<td>×</td>
<td>主键</td>
</tr>
<tr>
<td>课程号</td>
<td>Char</td>
<td>3</td>
<td>×</td>
<td>主键</td>
</tr>
<tr>
<td>成绩</td>
<td>Tinyint</td>
<td>1</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>学分</td>
<td>Tinyint</td>
<td>1</td>
<td>√</td>
</tr>
</tbody>
</table>
<h5 id="表4-学生情况表（xsqk）数据样本"><a href="#表4-学生情况表（xsqk）数据样本" class="headerlink" title="表4 学生情况表（xsqk）数据样本"></a>表4 学生情况表（xsqk）数据样本</h5><table>
<thead>
<tr>
<th>系别</th>
<th style="text-align:center">班级</th>
<th>专业</th>
<th style="text-align:center">学号</th>
<th style="text-align:center">姓名</th>
<th style="text-align:center">性别</th>
<th style="text-align:center">出生年月</th>
<th style="text-align:center">总学分</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>计算机</td>
<td style="text-align:center">计算机0203</td>
<td>计算机应用与维护</td>
<td style="text-align:center">02020101</td>
<td style="text-align:center">王玲玲</td>
<td style="text-align:center">女</td>
<td style="text-align:center">1981-8-26</td>
<td style="text-align:center">9</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">计算机0203</td>
<td>计算机应用与维护</td>
<td style="text-align:center">02020102</td>
<td style="text-align:center">张燕红</td>
<td style="text-align:center">女</td>
<td style="text-align:center">1981-10-20</td>
<td style="text-align:center">9</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">计算机0203</td>
<td>计算机应用与维护</td>
<td style="text-align:center">02020103</td>
<td style="text-align:center">杨勇</td>
<td style="text-align:center">男</td>
<td style="text-align:center">1982-3-15</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">计算机0203</td>
<td>计算机应用与维护</td>
<td style="text-align:center">02020104</td>
<td style="text-align:center">王红庆</td>
<td style="text-align:center">男</td>
<td style="text-align:center">1983-5-17</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">计算机0203</td>
<td>计算机应用与维护</td>
<td style="text-align:center">02020105</td>
<td style="text-align:center">陈园</td>
<td style="text-align:center">女</td>
<td style="text-align:center">1982-4-12</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">信息管理0201</td>
<td>信息管理</td>
<td style="text-align:center">02020201</td>
<td style="text-align:center">黄薇娜</td>
<td style="text-align:center">女</td>
<td style="text-align:center">1983-8-19</td>
<td style="text-align:center">8</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">信息管理0201</td>
<td>信息管理</td>
<td style="text-align:center">02020202</td>
<td style="text-align:center">沈昊</td>
<td style="text-align:center">男</td>
<td style="text-align:center">1982-3-18</td>
<td style="text-align:center">8</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">信息管理0201</td>
<td>信息管理</td>
<td style="text-align:center">02020203</td>
<td style="text-align:center">傅亮达</td>
<td style="text-align:center">男</td>
<td style="text-align:center">1983-1-22</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">信息管理0201</td>
<td>信息管理</td>
<td style="text-align:center">02020204</td>
<td style="text-align:center">任建刚</td>
<td style="text-align:center">男</td>
<td style="text-align:center">1981-12-21</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>计算机</td>
<td style="text-align:center">信息管理0201</td>
<td>信息管理</td>
<td style="text-align:center">02020205</td>
<td style="text-align:center">叶小红</td>
<td style="text-align:center">女</td>
<td style="text-align:center">1983-7-16</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h5 id="表5-学生课程表（xskc）数据样本"><a href="#表5-学生课程表（xskc）数据样本" class="headerlink" title="表5 学生课程表（xskc）数据样本"></a>表5 学生课程表（xskc）数据样本</h5><table>
<thead>
<tr>
<th>课程号</th>
<th>课程名</th>
<th>开课学期</th>
<th>学时</th>
<th>学分</th>
</tr>
</thead>
<tbody>
<tr>
<td>101</td>
<td>计算机文化基础</td>
<td>1</td>
<td>86</td>
<td>4</td>
</tr>
<tr>
<td>102</td>
<td>Qbasic</td>
<td>1</td>
<td>68</td>
<td>4</td>
</tr>
<tr>
<td>205</td>
<td>离散数学</td>
<td>3</td>
<td>64</td>
<td>4</td>
</tr>
<tr>
<td>206</td>
<td>VC</td>
<td>2</td>
<td>68</td>
<td>4</td>
</tr>
<tr>
<td>208</td>
<td>数据结构</td>
<td>2</td>
<td>68</td>
<td>4</td>
</tr>
<tr>
<td>210</td>
<td>操作系统</td>
<td>3</td>
<td>64</td>
<td>4</td>
</tr>
<tr>
<td>212</td>
<td>计算机组成</td>
<td>4</td>
<td>86</td>
<td>5</td>
</tr>
<tr>
<td>216</td>
<td>数据库原理</td>
<td>2</td>
<td>68</td>
<td>4</td>
</tr>
<tr>
<td>301</td>
<td>计算机网络</td>
<td>5</td>
<td>56</td>
<td>3</td>
</tr>
</tbody>
</table>
<h5 id="表6-学生成绩表（xscj）数据样本"><a href="#表6-学生成绩表（xscj）数据样本" class="headerlink" title="表6 学生成绩表（xscj）数据样本"></a>表6 学生成绩表（xscj）数据样本</h5><table>
<thead>
<tr>
<th>学号</th>
<th>课程号</th>
<th>成绩</th>
<th>学分</th>
</tr>
</thead>
<tbody>
<tr>
<td>02020101</td>
<td>101</td>
<td>85</td>
<td>4</td>
</tr>
<tr>
<td>02020101</td>
<td>102</td>
<td>70</td>
<td>5</td>
</tr>
<tr>
<td>02020102</td>
<td>101</td>
<td>90</td>
<td>4</td>
</tr>
<tr>
<td>02020102</td>
<td>102</td>
<td>80</td>
<td>5</td>
</tr>
<tr>
<td>02020201</td>
<td>101</td>
<td>86</td>
<td>4</td>
</tr>
<tr>
<td>02020201</td>
<td>208</td>
<td>80</td>
<td>4</td>
</tr>
<tr>
<td>02020202</td>
<td>208</td>
<td>50</td>
<td>4</td>
</tr>
<tr>
<td>02020202</td>
<td>216</td>
<td>60</td>
<td>4</td>
</tr>
</tbody>
</table>
<h4 id="一、触发器："><a href="#一、触发器：" class="headerlink" title="一、触发器："></a>一、触发器：</h4><p>1、在学生成绩库中创建触发器trigger1，实现如下功能：当在学生成绩表（xscj）中插入一条学生选课信息后，自动实现更新该学生在学生情况表（xsqk）中的总学分信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger1 <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> xscj</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">UPDATE</span> xsqk <span class="keyword">SET</span> xsqk.<span class="string">`总学分`</span> = xsqk.<span class="string">`总学分`</span> + new.<span class="string">`学分`</span> <span class="keyword">WHERE</span> xsqk.<span class="string">`学号`</span>=new.<span class="string">`学号`</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>分析：根据题意，要求在学生成绩表中插入一条记录时，自动更新学生情况表中的相应记录信息。可以通过在学生成绩表中定义INSERT类型的触发器，触发器中语句要完成的功能是更新学生情况表中的相应学生的总学分信息。其实，只要在该生原总学分基础上加上新选课程的学分就可以了。</p>
<p>2、创建触发器trigger2，实现当修改学生课程表（xskc）中的数据时，显示提示信息“学生课程表被修改了”。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger2 <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> xskc <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">SIGNAL <span class="keyword">SQLSTATE</span> <span class="string">'TX000'</span> <span class="keyword">SET</span> message_text=<span class="string">'学生课程表被修改了'</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>3、创建触发器trigger3，实现当删除学生课程表中某门课程的记录时，对应学生成绩表中所有有关此课程的记录均删除。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger3 <span class="keyword">AFTER</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> xskc</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> xscj <span class="keyword">WHERE</span> xscj.<span class="string">`课程号`</span> = old.<span class="string">`课程号`</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger3 <span class="keyword">AFTER</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> xskc</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> xscj <span class="keyword">WHERE</span> xscj.<span class="string">`课程号`</span> = xskc.<span class="string">`课程号`</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>其实我感觉这样做触发器不如直接做外键，做级联删除。</p>
<p>4、创建触发器trigger4，实现当修改学生课程表（xskc）中的某门课的课程号时，对应学生成绩表（xscj）中的课程号也作相应修改。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger4 <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> xskc</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">UPDATE</span> xscj <span class="keyword">SET</span> xscj.<span class="string">`课程号`</span> = new.<span class="string">`课程号`</span> <span class="keyword">where</span> xscj.<span class="string">`课程号`</span> = xskc.<span class="string">`课程号`</span>;</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger4 <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> xskc</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">UPDATE</span> xscj <span class="keyword">SET</span> xscj.<span class="string">`课程号`</span> = new.<span class="string">`课程号`</span> <span class="keyword">where</span> xscj.<span class="string">`课程号`</span> = old.<span class="string">`课程号`</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>这里也是添加外键做级联修改会容易理解一些，</p>
<p>5、创建触发器trigger5，实现当向学生成绩表（xscj）中插入一条选课记录时，查看该学生的信息是否存在在学生信息表中，如果不存在，则把该学生的基本信息加入到学生信息表中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger5 <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> xscj</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">IF</span>((<span class="keyword">SELECT</span> <span class="string">`学号`</span> <span class="keyword">FROM</span> xsqk <span class="keyword">WHERE</span> new.<span class="string">`学号`</span> = xsqk.<span class="string">`学号`</span>) <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">THEN</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> xsqk <span class="keyword">VALUES</span> (<span class="string">'计算机'</span>,<span class="string">''</span>,<span class="string">''</span>,new.<span class="string">`学号`</span>,<span class="string">'张浩森'</span>,<span class="string">''</span>,<span class="string">'1981-08-26'</span>,new.<span class="string">`成绩`</span>,<span class="string">''</span>);</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>6、在学生成绩库中创建触发器trigger6，实现如下功能：当在学生成绩表（xscj）中插入一条学生选课信息后，查看该学生的信息是否存在在学生信息表中，如果不存在，则给出“该记录不能被插入！”的错误提示，并撤销插入操作；同样，如果课程信息在课程信息表中不存在，给出“该记录不能被插入！”的错误提示，并撤销插入操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger6 <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> xscj</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">IF</span> ((<span class="keyword">SELECT</span> <span class="string">`学号`</span> <span class="keyword">FROM</span> xsqk <span class="keyword">WHERE</span> new.<span class="string">`学号`</span> = xsqk.<span class="string">`学号`</span>) <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">	<span class="keyword">THEN</span></span><br><span class="line">		SIGNAL <span class="keyword">SQLSTATE</span> <span class="string">'TX000'</span> <span class="keyword">SET</span> message_text = <span class="string">'该记录不能被插入'</span>;</span><br><span class="line">	ELSEIF((<span class="keyword">SELECT</span> cno <span class="keyword">FROM</span> xskc <span class="keyword">WHERE</span> new.<span class="string">`学号`</span> = <span class="string">`学号`</span>) <span class="keyword">is</span> <span class="literal">NULL</span>)</span><br><span class="line">	<span class="keyword">THEN</span></span><br><span class="line">		SIGNAL <span class="keyword">SQLSTATE</span> <span class="string">'TX000'</span> <span class="keyword">SET</span> message_text = <span class="string">'该记录不能被插入'</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>7、创建触发器trigger7，强制实现业务规则：当向学生成绩表中插入一条记录时，自动修改学生情况表中该学生的总学分，要求总学分为该学生所有已修课程的学分总和。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger7 <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> xscj</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> allxf <span class="built_in">int</span>;</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">sum</span>(<span class="string">`学分`</span>) <span class="keyword">INTO</span> allxf <span class="keyword">FROM</span> xscj <span class="keyword">WHERE</span> <span class="string">`学号`</span> = new.<span class="string">`学号`</span>;</span><br><span class="line">	<span class="keyword">UPDATE</span> xsqk <span class="keyword">SET</span> <span class="string">`总学分`</span> = allxf <span class="keyword">WHERE</span> <span class="string">`学号`</span> = new.<span class="string">`学号`</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>其实跟第一题是一样的，这里用了另一种方法实现，用DECLARE声明一个int变量，并且在INSERT后计算总学分和，再UPDATE xsqk中的数据。这样做比较好理解。</p>
<p>8、创建触发器trigger8，要求实现：当向xscj表插入一条记录时，判断该学生的总学分，如果总学分大于等于25，则给出“该学生已修满，不需要再选修！”的提示信息；否则，自动更新该学生的总学分。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger8 <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> xscj</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> allxf <span class="built_in">int</span>;</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">sum</span>(<span class="string">`学分`</span>) <span class="keyword">INTO</span> allxf <span class="keyword">FROM</span> xscj <span class="keyword">WHERE</span> <span class="string">`学号`</span> = new.<span class="string">`学号`</span>;</span><br><span class="line">	<span class="keyword">SET</span> allxf = allxf + new.<span class="string">`学分`</span>;</span><br><span class="line">	IF(allxf &gt;= 25)</span><br><span class="line">	THEN SIGNAL SQLSTATE 'TX001' <span class="keyword">SET</span> message_text=<span class="string">'该学生已修满，不需要再选修!'</span>;</span><br><span class="line">	ELSE <span class="keyword">UPDATE</span> xsqk <span class="keyword">SET</span> <span class="string">`总学分`</span> = allxf <span class="keyword">WHERE</span> <span class="string">`学号`</span> = new.<span class="string">`学号`</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>9、分别用触发器和存储过程实现对学生情况表（xsqk）和学生成绩表（xscj）的级联删除。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#触发器</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger9 <span class="keyword">AFTER</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> xsqk</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DELETE</span> <span class="keyword">FROM</span> xscj <span class="keyword">WHERE</span> <span class="string">`学号`</span> = old.<span class="string">`学号`</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#存储过程</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc (<span class="keyword">IN</span> parameter <span class="built_in">CHAR</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">IF</span>(parameter <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>)</span><br><span class="line">	<span class="keyword">THEN</span></span><br><span class="line">		<span class="keyword">DELETE</span> <span class="keyword">FROM</span> xsqk <span class="keyword">WHERE</span> <span class="string">`学号`</span> = parameter;</span><br><span class="line">		<span class="keyword">DELETE</span> <span class="keyword">FROM</span> xscj <span class="keyword">WHERE</span> <span class="string">`学号`</span> = parameter;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>10、在数据库中用以下语句创建两张表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`卷烟销售表`</span></span><br><span class="line">(</span><br><span class="line"><span class="string">`卷烟品牌`</span> <span class="built_in">VARCHAR</span>(<span class="number">40</span>) PRIMARY <span class="keyword">KEY</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`购货商`</span> <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`销售数量`</span> <span class="built_in">INT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`销售单价`</span> <span class="built_in">INT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`销售金额`</span> <span class="built_in">INT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`卷烟库存表`</span></span><br><span class="line">(</span><br><span class="line"><span class="string">`卷烟品牌`</span> <span class="built_in">VARCHAR</span>(<span class="number">40</span>) PRIMARY <span class="keyword">KEY</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`库存数量`</span> <span class="built_in">INT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`库存单价`</span> <span class="built_in">INT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="string">`库存金额`</span> <span class="built_in">INT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>–业务规则1：销售金额 = 销售数量 * 销售单价</p>
<p>–业务规则2：库存金额 = 库存数量 * 库存单价</p>
<p>创建触发器[T<em>INSERT</em>卷烟库存表]，实现每当[卷烟库存表]发生 INSERT 动作，则引发该触发器。触发器功能：强制执行业务规则2，保证插入的数据中，库存金额 = 库存数量 * 库存单价。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger10 <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="string">`卷烟库存表`</span></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SET</span> new.<span class="string">`库存金额`</span> = new.<span class="string">`库存数量`</span> + new.<span class="string">`库存单价`</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>测试用例：针对[卷烟库存表]，插入4条测试数据。注意，第一条数据（红塔山新势力）中的数据符合业务规则，第二条数据（红塔山人为峰）中，[库存金额]空，不符合业务规则，第三条数据（云南映像）中，[库存金额]不等于[库存数量]乘以[库存单价]，不符合业务规则。第四条数据库存数量为0。请注意在插入数据后，检查[卷烟库存表]中的数据是否满足：库存金额 = 库存数量 * 库存单价。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`卷烟库存表`</span>(<span class="string">`卷烟品牌`</span>,<span class="string">`库存数量`</span>,<span class="string">`库存单价`</span>,<span class="string">`库存金额`</span>) <span class="keyword">values</span>( <span class="string">'红塔山新势力'</span>,<span class="number">100</span>,<span class="number">12</span>,<span class="number">1200</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`卷烟库存表`</span>(<span class="string">`卷烟品牌`</span>,<span class="string">`库存数量`</span>,<span class="string">`库存单价`</span>,<span class="string">`库存金额`</span>) <span class="keyword">values</span>( <span class="string">'红塔山人为峰'</span>,<span class="number">100</span>,<span class="number">22</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`卷烟库存表`</span>(<span class="string">`卷烟品牌`</span>,<span class="string">`库存数量`</span>,<span class="string">`库存单价`</span>,<span class="string">`库存金额`</span>) <span class="keyword">values</span>( <span class="string">'云南映像'</span>,<span class="number">100</span>,<span class="number">60</span>,<span class="number">500</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`卷烟库存表`</span>(<span class="string">`卷烟品牌`</span>,<span class="string">`库存数量`</span>,<span class="string">`库存单价`</span>,<span class="string">`库存金额`</span>) <span class="keyword">values</span>( <span class="string">'玉溪'</span>,<span class="number">0</span>,<span class="number">30</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>验证结果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1frb6x44qywj30n304ojrm.jpg" alt=""></p>
<p>11、创建触发器[T<em>INSERT</em>卷烟销售表]，实现每当卷烟销售表发生 INSERT 动作，则引发该触发器。触发器功能： 实现业务规则：如果销售的卷烟品牌不存在库存或者库存为零，则返回错误。否则，判断是否符合业务规则1，如果符合，则自动减少卷烟库存表中对应品牌卷烟的库存数量和库存金额。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger11 <span class="keyword">BEFORE</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="string">`卷烟销售表`</span></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> num1 <span class="built_in">int</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> num2 <span class="built_in">int</span>;</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">into</span> num1 <span class="keyword">from</span> <span class="string">`卷烟库存表`</span> <span class="keyword">where</span> <span class="string">`卷烟品牌`</span> = new.<span class="string">`卷烟品牌`</span>;</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="string">`库存数量`</span> - new.<span class="string">`销售数量`</span> <span class="keyword">into</span> num2 <span class="keyword">from</span> <span class="string">`卷烟库存表`</span> <span class="keyword">where</span> <span class="string">`卷烟品牌`</span> = new.<span class="string">`卷烟品牌`</span>;</span><br><span class="line">	IF(num1 = 0 || num2&lt;=0 || (new.`销售金额` != new.`销售数量` * new.`销售单价`))</span><br><span class="line">		THEN</span><br><span class="line">		SIGNAL SQLSTATE 'TX001' <span class="keyword">SET</span> message_text=<span class="string">'该记录不能被插入'</span>;</span><br><span class="line">	ELSE</span><br><span class="line">		<span class="keyword">UPDATE</span> <span class="string">`卷烟库存表`</span> <span class="keyword">SET</span> <span class="string">`库存金额`</span> = (<span class="string">`库存数量`</span> - new.<span class="string">`销售数量`</span>) * <span class="string">`库存单价`</span>,<span class="string">`库存数量`</span> = <span class="string">`库存数量`</span> - new.<span class="string">`销售数量`</span> <span class="keyword">WHERE</span> <span class="string">`卷烟品牌`</span> = new.<span class="string">`卷烟品牌`</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a href="/2018/04/29/SQL练习2/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">zhs</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>